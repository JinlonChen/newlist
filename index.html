<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO æ¸…å•</title>
    <!-- Favicon å›¾æ ‡ -->
    <!-- ä¸ºWindowsåº”ç”¨æ·»åŠ å›¾æ ‡ -->
    <meta name="msapplication-TileImage" content="images/todo.png">
    <!-- åœ¨<head>æ ‡ç­¾å†…çš„ç°æœ‰faviconä»£ç æ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹ -->
    <link rel="apple-touch-icon" href="images/todo.png" sizes="180x180">
    <link rel="icon" href="images/todo.png" type="image/png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/todo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/todo.png">
    <link rel="shortcut icon" href="images/todo.png" type="image/png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- é…ç½®Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#495D84',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    }
                },
            }
        }
    </script>
    
    <!-- è‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .task-completed {
                text-decoration: line-through;
                color: #9ca3af;
            }
        }
    </style>
    
    <style>
        body {
            background-color: #16242C;
            background-image: linear-gradient(to right, rgba(255, 255, 255, 0.2) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(255, 255, 255, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .task-item {
            transition: all 0.2s ease;
        }
        
        .task-item:hover {
            background-color: #f3f4f6;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-border {
            border: 2px solid #495D84;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4 md:px-8">
    <!-- å¯†ç ä¿æŠ¤æ¨¡æ€æ¡† -->
    <div id="passwordModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">è¯·è¾“å…¥å¯†ç 1932</h2>
                <p class="text-gray-600 mt-2">æ­¤é¡µé¢éœ€è¦å¯†ç è®¿é—®</p>
            </div>
            <div class="space-y-4">
                <div>
                    <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç " 
                        class="w-full px-4 py-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg">
                </div>
                <div id="passwordError" class="text-danger text-sm hidden">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
                <button id="submitPasswordBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200">
                    ç¡®è®¤
                </button>
            </div>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ (é»˜è®¤éšè—ï¼Œå¯†ç éªŒè¯åæ˜¾ç¤º) -->
    <div id="mainContent" class="max-w-4xl mx-auto bg-[#FFFFFF] rounded-xl shadow-lg p-6 md:p-8 hidden">
        <header class="mb-8 text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">TODO æ¸…å•</h1>
            <p class="text-secondary mt-2">åœ¨ä»Šå¤©è¿™ä¸€å¤©ä¸­ï¼Œæœ€ä½é™åº¦æ˜¯å¿…é¡»å‘å‰è·¨è¿›ä¸€æ­¥</p>
        </header>
        
        <!-- ç¬¬ä¸€è¡Œæ¨¡å— -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <!-- ä¸‹æ‹‰èœå•æ¨¡å— -->
            <div class="flex-1">
                <label for="taskType" class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡ç±»å‹</label>
                <div class="relative">
                    <select id="taskType" class="block w-full pl-3 pr-10 py-2.5 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm rounded-lg">
                        <option value="dayTodo">å½“æ—¥è®¡åˆ’</option>
                        <option value="todo">å¾…åŠç®±</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>
            
            <!-- æ—¥æœŸé€‰æ‹©æ¨¡å— -->
            <div class="flex-1">
                <label for="datePicker" class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©æ—¥æœŸ</label>
                <div class="relative flex items-center">
                    <button id="prevDayBtn" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 z-10">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <input type="date" id="datePicker" class="block w-full pl-10 pr-10 py-2.5 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm rounded-lg">
                    <button id="nextDayBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 z-10">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- GitHubæŒ‰é’® -->
            <div class="flex-1 flex items-end">
                <button id="githubBtn" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center justify-center">
                    <i class="fa fa-github mr-2"></i>GitHubåŒæ­¥
                </button>
            </div>
        </div>
        
        <!-- GitHubåŒæ­¥æ¨¡å— (é»˜è®¤éšè—) -->
        <div id="githubSyncModule" class="hidden bg-gray-50 p-4 rounded-lg mb-6 fade-in">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-medium text-gray-800">GitHubåŒæ­¥è®¾ç½®</h3>
                <div class="flex items-center">
                    <span class="text-sm text-gray-600 mr-2">è‡ªåŠ¨åŒæ­¥</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSyncToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <button id="closeGithubBtn" class="text-gray-500 hover:text-gray-700 ml-4">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="githubToken" class="block text-sm font-medium text-gray-700 mb-1">GitHub Token</label>
                    <input type="password" id="githubToken" placeholder="è¾“å…¥GitHub Token" class="block w-full px-3 py-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg">
                </div>
                <div>
                    <label for="gistId" class="block text-sm font-medium text-gray-700 mb-1">Gist ID</label>
                    <input type="text" id="gistId" placeholder="è¾“å…¥Gist ID" class="block w-full px-3 py-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="syncToGithubBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center justify-center">
                    <i class="fa fa-upload mr-2"></i>ä¸Šä¼ æ•°æ®
                </button>
                <button id="syncFromGithubBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center justify-center">
                    <i class="fa fa-download mr-2"></i>ä¸‹è½½æ•°æ®
                </button>
            </div>
            <div id="syncStatus" class="mt-3 text-sm text-center hidden"></div>
        </div>
        
        <!-- ç¬¬äºŒè¡Œï¼šå½“æœˆç›®æ ‡æ¨¡å— -->
        <div id="monthlyGoalsModule" class="mb-6 bg-white p-4 rounded-lg card-border shadow-sm">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-medium text-gray-800">å½“æœˆç›®æ ‡</h3>
                <button id="toggleGoalsBtn" class="text-primary hover:text-primary/80 text-sm">
                    <i class="fa fa-chevron-down mr-1"></i>å±•å¼€/æ”¶èµ·
                </button>
            </div>
            <div id="monthlyGoalsContainer">
                <div id="goalsList" class="space-y-3">
                    <!-- ç›®æ ‡è¾“å…¥æ¡†å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    <div class="goal-item flex items-center">
                        <input type="text" class="goal-input flex-1 px-3 py-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg" placeholder="æ·»åŠ å½“æœˆç›®æ ‡...">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä»»åŠ¡è¾“å…¥æ¡† -->
        <div class="mb-6">
            <div class="flex items-center gap-3">
                <div class="relative flex-1">
                    <input type="text" id="taskInput" placeholder="è¾“å…¥æ–°çš„ä»»åŠ¡..." class="w-full pl-10 pr-4 py-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
                        <i class="fa fa-plus-circle"></i>
                    </div>
                </div>
                <button id="addTaskBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200 flex-shrink-0">
                    æ·»åŠ 
                </button>
            </div>
        </div>
        
        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="mb-6">
            <h2 id="taskListTitle" class="text-lg font-semibold text-gray-800 mb-3">ä»Šæ—¥æ—¥ç¨‹</h2>
            <div id="taskList" class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                <!-- ä»»åŠ¡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                <div id="emptyState" class="text-center py-10 text-gray-500">
                    <i class="fa fa-calendar-o text-4xl mb-3"></i>
                    <p>æš‚æ— ä»»åŠ¡</p>
                </div>
            </div>
        </div>
        
        <!-- æ—¥æœŸæ€»ç»“è¾“å…¥æ¡† -->
        <div>
            <label for="dailySummary" class="block text-sm font-medium text-gray-700 mb-1">ä»Šæ—¥æ€»ç»“</label>
            <textarea id="dailySummary" rows="3" placeholder="è®°å½•ä»Šå¤©çš„å¿ƒå¾—ä½“ä¼š..." class="w-full px-4 py-3 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg"></textarea>
            <div class="mt-3 flex justify-end">
                <button id="saveSummaryBtn" class="bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200">
                    ä¿å­˜æ€»ç»“
                </button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† (é»˜è®¤éšè—) -->
    <div id="editModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden fade-in">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">ç¼–è¾‘ä»»åŠ¡</h3>
                <button id="closeEditModalBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editTaskId">
                <input type="hidden" id="editTaskType">
                
                <div class="mb-4">
                    <label for="editTaskContent" class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡å†…å®¹</label>
                    <input type="text" id="editTaskContent" class="w-full px-4 py-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg">
                </div>
                
                <div class="mb-4">
                    <label for="editTaskDate" class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                    <input type="date" id="editTaskDate" class="w-full px-4 py-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg">
                    <div class="flex gap-4 mt-1">
                        <button id="removeTaskDateBtn" class="text-sm text-primary hover:text-primary/80">æ²¡æœ‰æ—¥æœŸ</button>
                        <button id="moveToTomorrowBtn" class="text-sm text-primary hover:text-primary/80">æ˜å¤©</button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="editTaskDescription" class="block text-sm font-medium text-gray-700 mb-1">æè¿° (å¯é€‰)</label>
                    <textarea id="editTaskDescription" rows="2" placeholder="æ·»åŠ æ›´å¤šç»†èŠ‚..." class="w-full px-4 py-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg"></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="editTaskCompleted" class="form-checkbox h-5 w-5 text-primary">
                        <span class="ml-2 text-sm text-gray-700">å·²å®Œæˆ</span>
                    </label>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200">
                        ä¿å­˜ä¿®æ”¹
                    </button>
                    <button type="button" id="cancelEditBtn" class="flex-1 border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-200">
                        å–æ¶ˆ
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // å¯†ç éªŒè¯åŠŸèƒ½
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');
        const passwordError = document.getElementById('passwordError');
        const mainContent = document.getElementById('mainContent');
        
        // æ­£ç¡®å¯†ç 
        const CORRECT_PASSWORD = '0000';
        
        // éªŒè¯å¯†ç 
        function validatePassword() {
            const enteredPassword = passwordInput.value;
            
            if (enteredPassword === CORRECT_PASSWORD) {
                // å¯†ç æ­£ç¡®ï¼Œæ˜¾ç¤ºä¸»å†…å®¹ï¼Œéšè—å¯†ç æ¨¡æ€æ¡†
                passwordModal.classList.add('hidden');
                mainContent.classList.remove('hidden');
                passwordError.classList.add('hidden');
                
                // åˆå§‹åŒ–åº”ç”¨
                initApp();
            } else {
                // å¯†ç é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        // æäº¤å¯†ç äº‹ä»¶
        submitPasswordBtn.addEventListener('click', validatePassword);
        
        // æŒ‰Enteré”®æäº¤å¯†ç 
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validatePassword();
            }
        });
        
        // åº”ç”¨åˆå§‹åŒ–å‡½æ•°
        function initApp() {
            // DOMå…ƒç´ 
            const taskTypeSelect = document.getElementById('taskType');
            const datePicker = document.getElementById('datePicker');
            const githubBtn = document.getElementById('githubBtn');
            const githubSyncModule = document.getElementById('githubSyncModule');
            const closeGithubBtn = document.getElementById('closeGithubBtn');
            const taskInput = document.getElementById('taskInput');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const taskList = document.getElementById('taskList');
            const emptyState = document.getElementById('emptyState');
            const taskListTitle = document.getElementById('taskListTitle');
            const dailySummary = document.getElementById('dailySummary');
            const saveSummaryBtn = document.getElementById('saveSummaryBtn');
            const editModal = document.getElementById('editModal');
            const closeEditModalBtn = document.getElementById('closeEditModalBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const editForm = document.getElementById('editForm');
            const githubToken = document.getElementById('githubToken');
            const gistId = document.getElementById('gistId');
            const syncToGithubBtn = document.getElementById('syncToGithubBtn');
            const syncFromGithubBtn = document.getElementById('syncFromGithubBtn');
            const syncStatus = document.getElementById('syncStatus');
            const autoSyncToggle = document.getElementById('autoSyncToggle');
            const toggleGoalsBtn = document.getElementById('toggleGoalsBtn');
            const monthlyGoalsContainer = document.getElementById('monthlyGoalsContainer');
            const goalsList = document.getElementById('goalsList');
            
            // å­˜å‚¨é”®å
            const STORAGE_KEY = 'new-schedule-app-data';
            const SYNC_SETTINGS_KEY = 'github-sync-settings';
            const MONTHLY_GOALS_KEY = 'monthly-goals';
            
            // è‡ªåŠ¨åŒæ­¥ç›¸å…³å˜é‡
            let autoSyncInterval = null;
            const AUTO_SYNC_INTERVAL_MINUTES = 15; // æ¯15åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
            
            // åˆå§‹åŒ–æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date();
            const formattedToday = formatDate(today);
            datePicker.value = formattedToday;
            
            // åˆå§‹åŒ–
            loadTasks();
            loadSummary();
            loadSyncSettings();
            loadMonthlyGoals();
            initAutoSync();
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // è·å–å½“å‰æœˆä»½çš„é”®åï¼ˆåŸºäºæ—¥æœŸé€‰æ‹©å™¨ä¸­çš„æ—¥æœŸï¼‰
        function getCurrentMonthKey() {
            const selectedDate = new Date(datePicker.value);
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        
        // åŠ è½½æ•°æ®
        function loadData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : {
                    dayTodos: {},
                    todos: [],
                    summaries: {}
                };
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                return {
                    dayTodos: {},
                    todos: [],
                    summaries: {}
                };
            }
        }
        
        // ä¿å­˜æ•°æ®
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        
        // åŠ è½½ä»»åŠ¡
        function loadTasks() {
            const data = loadData();
            const currentType = taskTypeSelect.value;
            const currentDate = datePicker.value;
            
            // æ›´æ–°æ ‡é¢˜
            updateTaskListTitle();
            
            // æ¸…ç©ºåˆ—è¡¨
            taskList.innerHTML = '';
            
            let tasks = [];
            
            if (currentType === 'dayTodo') {
                // åŠ è½½å½“å¤©çš„æ—¥ç¨‹
                tasks = data.dayTodos[currentDate] || [];
            } else {
                // åŠ è½½å¾…åŠäº‹é¡¹
                tasks = data.todos;
            }
            
            // æ˜¾ç¤ºç©ºçŠ¶æ€æˆ–ä»»åŠ¡åˆ—è¡¨
            if (tasks.length === 0) {
                taskList.appendChild(emptyState);
            } else {
                // æ¸²æŸ“ä»»åŠ¡
                tasks.forEach(task => {
                    addTaskToUI(task);
                });
            }
        }
        
        // æ›´æ–°ä»»åŠ¡åˆ—è¡¨æ ‡é¢˜
        function updateTaskListTitle() {
            const currentType = taskTypeSelect.value;
            const currentDate = datePicker.value;
            
            if (currentType === 'dayTodo') {
                const [year, month, day] = currentDate.split('-');
                taskListTitle.textContent = `${year}å¹´${month}æœˆ${day}æ—¥ æ—¥ç¨‹`;
            } else {
                taskListTitle.textContent = 'å¾…åŠäº‹é¡¹';
            }
        }
        
        // æ·»åŠ ä»»åŠ¡åˆ°UI
        function addTaskToUI(task) {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item flex items-center p-3 border border-gray-200 rounded-lg';
            taskItem.dataset.id = task.id;
            taskItem.dataset.type = task.type;
            taskItem.dataset.date = task.date;
            
            // ä»»åŠ¡å®ŒæˆçŠ¶æ€çš„æ ·å¼
            const completedClass = task.completed ? 'task-completed' : '';
            
            taskItem.innerHTML = `
                <div class="flex items-center flex-1">
                    <input type="checkbox" class="task-checkbox h-5 w-5 text-primary rounded mr-3" ${task.completed ? 'checked' : ''}>
                    <div class="flex-1">
                        <p class="${completedClass} task-content cursor-pointer">${task.content}</p>
                        ${task.description ? `<p class="text-sm text-gray-500">${task.description}</p>` : ''}
                    </div>
                </div>
                <button class="delete-task-btn text-gray-400 hover:text-danger ml-2">
                    <i class="fa fa-trash"></i>
                </button>
            `;
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const checkbox = taskItem.querySelector('.task-checkbox');
            checkbox.addEventListener('change', () => toggleTaskCompletion(task.id, task.type, task.date));
            
            const content = taskItem.querySelector('.task-content');
            content.addEventListener('click', () => openEditModal(task));
            
            const deleteBtn = taskItem.querySelector('.delete-task-btn');
            deleteBtn.addEventListener('click', () => deleteTask(task.id, task.type, task.date));
            
            taskList.appendChild(taskItem);
        }
        
        // æ·»åŠ æ–°ä»»åŠ¡
        function addTask() {
            const content = taskInput.value.trim();
            if (!content) return;
            
            const currentType = taskTypeSelect.value;
            const currentDate = datePicker.value;
            
            const task = {
                id: Date.now().toString(),
                content: content,
                description: '',
                type: currentType,
                date: currentType === 'dayTodo' ? currentDate : '',
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            const data = loadData();
            
            if (currentType === 'dayTodo') {
                // æ·»åŠ åˆ°å½“å¤©æ—¥ç¨‹
                if (!data.dayTodos[currentDate]) {
                    data.dayTodos[currentDate] = [];
                }
                data.dayTodos[currentDate].push(task);
            } else {
                // æ·»åŠ åˆ°å¾…åŠäº‹é¡¹
                data.todos.push(task);
            }
            
            saveData(data);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            taskInput.value = '';
            
            // é‡æ–°åŠ è½½ä»»åŠ¡
            loadTasks();
        }
        
        // åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
        function toggleTaskCompletion(taskId, taskType, taskDate) {
            const data = loadData();
            
            if (taskType === 'dayTodo') {
                // åˆ‡æ¢å½“å¤©æ—¥ç¨‹çš„å®ŒæˆçŠ¶æ€
                const tasks = data.dayTodos[taskDate] || [];
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    data.dayTodos[taskDate] = tasks;
                }
            } else {
                // åˆ‡æ¢å¾…åŠäº‹é¡¹çš„å®ŒæˆçŠ¶æ€
                const task = data.todos.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                }
            }
            
            saveData(data);
            
            // é‡æ–°åŠ è½½ä»»åŠ¡
            loadTasks();
        }
        
        // åˆ é™¤ä»»åŠ¡
        function deleteTask(taskId, taskType, taskDate) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
            
            const data = loadData();
            
            if (taskType === 'dayTodo') {
                // åˆ é™¤å½“å¤©æ—¥ç¨‹
                let tasks = data.dayTodos[taskDate] || [];
                tasks = tasks.filter(t => t.id !== taskId);
                
                if (tasks.length === 0) {
                    delete data.dayTodos[taskDate];
                } else {
                    data.dayTodos[taskDate] = tasks;
                }
            } else {
                // åˆ é™¤å¾…åŠäº‹é¡¹
                data.todos = data.todos.filter(t => t.id !== taskId);
            }
            
            saveData(data);
            
            // é‡æ–°åŠ è½½ä»»åŠ¡
            loadTasks();
        }
        
        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal(task) {
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskType').value = task.type;
            document.getElementById('editTaskContent').value = task.content;
            document.getElementById('editTaskDate').value = task.date;
            document.getElementById('editTaskDescription').value = task.description || '';
            document.getElementById('editTaskCompleted').checked = task.completed;
            
            editModal.classList.remove('hidden');
        }
        
        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            editModal.classList.add('hidden');
        }
        
        // æ›´æ–°ä»»åŠ¡
        function updateTask(e) {
            e.preventDefault();
            
            const taskId = document.getElementById('editTaskId').value;
            const taskType = document.getElementById('editTaskType').value;
            const content = document.getElementById('editTaskContent').value.trim();
            const newDate = document.getElementById('editTaskDate').value;
            const description = document.getElementById('editTaskDescription').value.trim();
            const completed = document.getElementById('editTaskCompleted').checked;
            
            if (!content) return;
            
            const data = loadData();
            let task;
            let shouldNavigateToNewDate = false;
            let originalDate = '';
            
            if (taskType === 'dayTodo') {
                // æ‰¾åˆ°åŸå§‹æ—¥æœŸå’Œä»»åŠ¡
                for (const date in data.dayTodos) {
                    const foundTask = data.dayTodos[date].find(t => t.id === taskId);
                    if (foundTask) {
                        task = foundTask;
                        originalDate = date;
                        break;
                    }
                }
                
                if (task) {
                    // å¦‚æœæ—¥æœŸå‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦ç§»åŠ¨ä»»åŠ¡
                    if (originalDate && originalDate !== newDate) {
                        // ä»åŸå§‹æ—¥æœŸç§»é™¤ä»»åŠ¡
                        data.dayTodos[originalDate] = data.dayTodos[originalDate].filter(t => t.id !== taskId);
                        
                        // å¦‚æœåŸå§‹æ—¥æœŸæ²¡æœ‰ä»»åŠ¡äº†ï¼Œåˆ é™¤è¯¥æ—¥æœŸ
                        if (data.dayTodos[originalDate].length === 0) {
                            delete data.dayTodos[originalDate];
                        }
                        
                        // æ·»åŠ åˆ°æ–°æ—¥æœŸ
                        if (!data.dayTodos[newDate]) {
                            data.dayTodos[newDate] = [];
                        }
                        data.dayTodos[newDate].push(task);
                        
                        // æ›´æ–°ä»»åŠ¡æ—¥æœŸ
                        task.date = newDate;
                        
                        // è®¾ç½®å¯¼èˆªæ ‡å¿—
                        shouldNavigateToNewDate = true;
                    }
                    
                    // æ›´æ–°å…¶ä»–ä»»åŠ¡å±æ€§
                    task.content = content;
                    task.description = description;
                    task.completed = completed;
                }
            } else {
                // æ›´æ–°å¾…åŠäº‹é¡¹
                task = data.todos.find(t => t.id === taskId);
                
                if (task) {
                    task.content = content;
                    task.description = description;
                    task.completed = completed;
                    
                    // å¦‚æœè®¾ç½®äº†æ—¥æœŸï¼Œå°†å¾…åŠäº‹é¡¹ç§»åŠ¨åˆ°å¯¹åº”æ—¥æœŸçš„æ—¥ç¨‹ä¸­
                    if (newDate && newDate !== task.date) {
                        // ä»å¾…åŠäº‹é¡¹ä¸­ç§»é™¤
                        data.todos = data.todos.filter(t => t.id !== taskId);
                        
                        // æ·»åŠ åˆ°å¯¹åº”æ—¥æœŸçš„æ—¥ç¨‹ä¸­
                        if (!data.dayTodos[newDate]) {
                            data.dayTodos[newDate] = [];
                        }
                        
                        // æ›´æ–°ä»»åŠ¡ç±»å‹å’Œæ—¥æœŸ
                        task.type = 'dayTodo';
                        task.date = newDate;
                        
                        data.dayTodos[newDate].push(task);
                        
                        // è®¾ç½®æ ‡è®°ï¼Œéœ€è¦å¯¼èˆªåˆ°æ–°æ—¥æœŸ
                        shouldNavigateToNewDate = true;
                    }
                }
            }
            
            saveData(data);
            closeEditModal();
            
            // å¦‚æœéœ€è¦å¯¼èˆªåˆ°æ–°æ—¥æœŸï¼Œåˆ™æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨å¹¶é‡æ–°åŠ è½½ä»»åŠ¡
            if (shouldNavigateToNewDate && newDate) {
                datePicker.value = newDate;
            }
            
            loadTasks();
        }
        
        // åŠ è½½æ€»ç»“
        function loadSummary() {
            const data = loadData();
            const currentDate = datePicker.value;
            dailySummary.value = data.summaries[currentDate] || '';
        }
        
        // ä¿å­˜æ€»ç»“
        function saveSummary() {
            const data = loadData();
            const currentDate = datePicker.value;
            data.summaries[currentDate] = dailySummary.value;
            saveData(data);
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            const originalText = saveSummaryBtn.textContent;
            saveSummaryBtn.textContent = 'å·²ä¿å­˜ï¼';
            saveSummaryBtn.classList.add('bg-success');
            
            setTimeout(() => {
                saveSummaryBtn.textContent = originalText;
                saveSummaryBtn.classList.remove('bg-success');
            }, 2000);
        }
        
        // åŠ è½½åŒæ­¥è®¾ç½®
        function loadSyncSettings() {
            try {
                const settings = localStorage.getItem(SYNC_SETTINGS_KEY);
                if (settings) {
                    const { token, gist, autoSync } = JSON.parse(settings);
                    if (token) githubToken.value = token;
                    if (gist) gistId.value = gist;
                    if (autoSync !== undefined) autoSyncToggle.checked = autoSync;
                }
            } catch (error) {
                console.error('åŠ è½½åŒæ­¥è®¾ç½®å¤±è´¥:', error);
            }
        }
        
        // ä¿å­˜åŒæ­¥è®¾ç½®
        function saveSyncSettings() {
            const settings = {
                token: githubToken.value,
                gist: gistId.value,
                autoSync: autoSyncToggle.checked
            };
            localStorage.setItem(SYNC_SETTINGS_KEY, JSON.stringify(settings));
        }
        
        // åˆå§‹åŒ–è‡ªåŠ¨åŒæ­¥
        function initAutoSync() {
            const settings = localStorage.getItem(SYNC_SETTINGS_KEY);
            if (settings) {
                const { autoSync } = JSON.parse(settings);
                if (autoSync) {
                    startAutoSync();
                }
            }
        }
        
        // å¼€å§‹è‡ªåŠ¨åŒæ­¥
        function startAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
            
            // æ¯15åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
            autoSyncInterval = setInterval(async () => {
                if (githubToken.value && gistId.value) {
                    await syncToGitHub();
                }
            }, AUTO_SYNC_INTERVAL_MINUTES * 60 * 1000);
        }
        
        // åœæ­¢è‡ªåŠ¨åŒæ­¥
        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
        }
        
        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
        function showSyncStatus(message, isSuccess = true) {
            syncStatus.textContent = message;
            syncStatus.className = `mt-3 text-sm text-center ${isSuccess ? 'text-success' : 'text-danger'}`;
            syncStatus.classList.remove('hidden');
            
            setTimeout(() => {
                syncStatus.classList.add('hidden');
            }, 3000);
        }
        
        // åŒæ­¥åˆ°GitHub
        async function syncToGitHub() {
            saveSyncSettings();
            const token = githubToken.value.trim();
            const gistIdValue = gistId.value.trim();
            
            if (!token) {
                showSyncStatus('è¯·è¾“å…¥GitHub Token', false);
                return;
            }
            
            showSyncStatus('æ­£åœ¨ä¸Šä¼ ...');
            
            const data = loadData();
            // åŒæ—¶ä¿å­˜å½“æœˆç›®æ ‡æ•°æ®
            const monthlyGoalsData = loadMonthlyGoals();
            data.monthlyGoals = monthlyGoalsData;
            
            const syncData = {
                description: 'æ—¥ç¨‹å®‰æ’æ•°æ®',
                public: false,
                files: {
                    'schedule-data.json': {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            };
            
            try {
                let response;
                if (gistIdValue) {
                    response = await fetch(`https://api.github.com/gists/${gistIdValue}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(syncData)
                    });
                } else {
                    response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(syncData)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    if (!gistIdValue) {
                        gistId.value = result.id;
                        saveSyncSettings();
                    }
                    showSyncStatus('ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    throw new Error('ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                showSyncStatus('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„Tokenå’ŒGist ID', false);
            }
        }
        
        // ä»GitHubåŒæ­¥
        async function syncFromGitHub() {
            saveSyncSettings();
            const token = githubToken.value.trim();
            const gistIdValue = gistId.value.trim();
            
            if (!token || !gistIdValue) {
                showSyncStatus('è¯·è¾“å…¥GitHub Tokenå’ŒGist ID', false);
                return;
            }
            
            showSyncStatus('æ­£åœ¨ä¸‹è½½...');
            
            try {
                console.log('===========================================');
                console.log('å¼€å§‹ä»GitHubåŒæ­¥æ•°æ®');
                console.log('Gist ID:', gistIdValue);
                console.log('Token é•¿åº¦:', token.length, 'ä¸ªå­—ç¬¦');
                
                // å°è¯•ä¸ä½¿ç”¨Authorizationå¤´è·å–å…¬å¼€Gist
                let response;
                try {
                    console.log('å°è¯•ä½¿ç”¨Authorizationå¤´è·å–Gist...');
                    response = await fetch(`https://api.github.com/gists/${gistIdValue}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'User-Agent': 'TODO-List-App'
                        },
                        method: 'GET'
                    });
                } catch (authError) {
                    console.error('ä½¿ç”¨Authorizationå¤´å‡ºé”™ï¼Œå°è¯•ä¸ä½¿ç”¨Authorizationå¤´...', authError);
                    // å°è¯•ä¸ä½¿ç”¨Authorizationå¤´ï¼ˆå…¬å¼€Gistï¼‰
                    response = await fetch(`https://api.github.com/gists/${gistIdValue}`, {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'User-Agent': 'TODO-List-App'
                        },
                        method: 'GET'
                    });
                }
                
                // è®°å½•å“åº”çŠ¶æ€å’Œå¤´ä¿¡æ¯
                console.log('GitHub API å“åº”çŠ¶æ€:', response.status, response.statusText);
                console.log('GitHub API å“åº”å¤´:');
                for (const [key, value] of response.headers.entries()) {
                    console.log(`  ${key}: ${value}`);
                }
                
                // è·å–åŸå§‹å“åº”æ–‡æœ¬ä»¥ä¾¿è°ƒè¯•
                const rawResponse = await response.clone().text();
                console.log('åŸå§‹å“åº”å†…å®¹é•¿åº¦:', rawResponse.length, 'ä¸ªå­—ç¬¦');
                console.log('åŸå§‹å“åº”å†…å®¹é¢„è§ˆ:', rawResponse.substring(0, 1000) + (rawResponse.length > 1000 ? '...' : ''));
                
                if (response.ok) {
                    try {
                        const result = await response.json();
                        console.log('è§£æGistæ•°æ®æˆåŠŸ');
                        console.log('Gist æ•°æ®ç»“æ„:', Object.keys(result));
                        console.log('Gist æè¿°:', result.description || 'æ— æè¿°');
                        console.log('Gist ID:', result.id);
                        console.log('Gist åˆ›å»ºæ—¶é—´:', result.created_at);
                        console.log('Gist æ›´æ–°æ—¶é—´:', result.updated_at);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰fileså±æ€§
                        if (!result.files) {
                            console.error('âŒ Gist æ•°æ®ä¸­æ²¡æœ‰fileså±æ€§');
                            showSyncStatus('Gist æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œç¼ºå°‘æ–‡ä»¶ä¿¡æ¯', false);
                            return;
                        }
                        
                        const files = Object.keys(result.files);
                        console.log(`âœ… æ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶`);
                        console.log('æ–‡ä»¶åˆ—è¡¨:', files);
                        
                        if (files.length === 0) {
                            console.error('âŒ Gist ä¸­æ²¡æœ‰æ–‡ä»¶');
                            showSyncStatus('Gist ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ–‡ä»¶', false);
                            return;
                        }
                        
                        // è¯¦ç»†è®°å½•æ¯ä¸ªæ–‡ä»¶çš„ä¿¡æ¯
                        console.log('æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:');
                        for (const [filename, file] of Object.entries(result.files)) {
                            console.log(`  - ${filename}:`);
                            console.log(`    ç±»å‹: ${file.type}`);
                            console.log(`    è¯­è¨€: ${file.language || 'æœªçŸ¥'}`);
                            console.log(`    æœ‰content: ${!!file.content}`);
                            console.log(`    contentç±»å‹: ${typeof file.content}`);
                            if (file.content) {
                                console.log(`    contenté•¿åº¦: ${file.content.length} å­—ç¬¦`);
                                console.log(`    contenté¢„è§ˆ: ${file.content.substring(0, 100)}${file.content.length > 100 ? '...' : ''}`);
                            }
                        }
                        
                        // å°è¯•æŸ¥æ‰¾æ–‡ä»¶å†…å®¹
                        console.log('\nğŸ” å°è¯•æŸ¥æ‰¾å¹¶ä½¿ç”¨ä»»ä½•å¯ç”¨çš„æ–‡ä»¶å†…å®¹...');
                        let fileContent = null;
                        let foundFile = null;
                        
                        // 1. é¦–å…ˆå°è¯•æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶å
                        const possibleFilenames = [
                            'schedule-data.json', 'todo-data.json', 'data.json', 'tasks.json',
                            'new-schedule-app-data.json', 'todo-list.json', 'schedule.json'
                        ];
                        
                        for (const filename of possibleFilenames) {
                            if (result.files[filename] && result.files[filename].content) {
                                fileContent = result.files[filename].content;
                                foundFile = filename;
                                console.log(`âœ… æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶å: ${filename}`);
                                break;
                            }
                        }
                        
                        // 2. å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶åï¼Œå°è¯•ä»»ä½•æ–‡ä»¶
                        if (!fileContent) {
                            console.log('æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶åï¼Œå°è¯•ä½¿ç”¨ä»»ä½•æœ‰å†…å®¹çš„æ–‡ä»¶...');
                            
                            // éå†æ‰€æœ‰æ–‡ä»¶
                            for (const [filename, file] of Object.entries(result.files)) {
                                console.log(`å°è¯•æ–‡ä»¶: ${filename}`);
                                
                                if (file && file.content && typeof file.content === 'string') {
                                    fileContent = file.content;
                                    foundFile = filename;
                                    console.log(`ğŸ“„ é€‰æ‹©æ–‡ä»¶: ${filename}`);
                                    break;
                                }
                            }
                        }
                        
                        if (fileContent) {
                            console.log(`âœ… æ‰¾åˆ°æ–‡ä»¶: ${foundFile}`);
                            console.log(`æ–‡ä»¶å†…å®¹é•¿åº¦: ${fileContent.length} å­—ç¬¦`);
                            
                            // ä¿å­˜åŸå§‹å†…å®¹åˆ°æœ¬åœ°å­˜å‚¨ä»¥ä¾¿æ£€æŸ¥
                            try {
                                const backupData = {
                                    originalContent: fileContent,
                                    filename: foundFile,
                                    timestamp: new Date().toISOString(),
                                    gistId: gistIdValue
                                };
                                localStorage.setItem('backup-gist-data', JSON.stringify(backupData));
                                console.log('âœ… åŸå§‹å†…å®¹å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œé”®: backup-gist-data');
                            } catch (e) {
                                console.error('æ— æ³•ä¿å­˜å¤‡ä»½æ•°æ®:', e);
                            }
                            
                            // å°è¯•è§£æJSONï¼Œå¢åŠ æ•°æ®ä¿®å¤å°è¯•
                            try {
                                // å°è¯•æ¸…ç†å’Œä¿®å¤å†…å®¹
                                let cleanContent = fileContent.trim();
                                
                                // ç§»é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„BOMå­—ç¬¦
                                if (cleanContent.charCodeAt(0) === 0xFEFF) {
                                    cleanContent = cleanContent.slice(1);
                                    console.log('âœ… ç§»é™¤äº†BOMå­—ç¬¦');
                                }
                                
                                // å°è¯•è§£æä¿®å¤åçš„å†…å®¹
                                let remoteData = JSON.parse(cleanContent);
                                console.log('âœ… æˆåŠŸè§£æJSONæ•°æ®');
                                console.log('æ•°æ®ç±»å‹:', typeof remoteData);
                                
                                if (typeof remoteData === 'object' && remoteData !== null) {
                                    console.log('æ•°æ®é”®:', Object.keys(remoteData));
                                    
                                    // ä¿å­˜æ•°æ®
                                    saveData(remoteData);
                                    console.log('âœ… æ•°æ®ä¿å­˜æˆåŠŸ');
                                    
                                    // æ¢å¤å½“æœˆç›®æ ‡æ•°æ®
                                    if (remoteData.monthlyGoals) {
                                        console.log('âœ… å‘ç°å¹¶æ¢å¤å½“æœˆç›®æ ‡æ•°æ®');
                                        saveMonthlyGoals(remoteData.monthlyGoals);
                                    }
                                    
                                    // é‡æ–°åŠ è½½
                                    loadTasks();
                                    loadSummary();
                                    loadMonthlyGoals();
                                    console.log('âœ… æ•°æ®åŠ è½½å®Œæˆ');
                                    
                                    showSyncStatus(`ä¸‹è½½æˆåŠŸï¼ä»æ–‡ä»¶ ${foundFile} æ¢å¤æ•°æ®`, true);
                                } else {
                                    console.error('âŒ æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„å¯¹è±¡');
                                    showSyncStatus('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œä¸æ˜¯æœ‰æ•ˆçš„æ•°æ®å¯¹è±¡', false);
                                }
                            } catch (parseError) {
                                console.error('âŒ JSONè§£æå¤±è´¥:', parseError);
                                console.error('é”™è¯¯å†…å®¹å‰300å­—ç¬¦:', fileContent.substring(0, 300));
                                
                                // å°è¯•æ•°æ®ä¿®å¤
                                console.log('âš ï¸  å°è¯•æ•°æ®ä¿®å¤å’Œæ¢å¤...');
                                
                                // 1. ä¿å­˜æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                                try {
                                    const errorInfo = {
                                        filename: foundFile,
                                        errorMessage: parseError.message,
                                        errorType: parseError.name,
                                        timestamp: new Date().toISOString(),
                                        contentSample: fileContent.substring(0, 500),
                                        contentLength: fileContent.length
                                    };
                                    localStorage.setItem('sync-error-details', JSON.stringify(errorInfo));
                                    console.log('âœ… é”™è¯¯è¯¦æƒ…å·²ä¿å­˜åˆ°localStorage');
                                } catch (e) {
                                    console.error('æ— æ³•ä¿å­˜é”™è¯¯è¯¦æƒ…:', e);
                                }
                                
                                // 2. å¢å¼ºçš„é»˜è®¤æ•°æ®ç»“æ„åˆ›å»º
                                try {
                                    console.log('ğŸ”„ åˆ›å»ºå®Œæ•´çš„é»˜è®¤æ•°æ®ç»“æ„...');
                                    
                                    // è·å–å½“å‰æ—¥æœŸï¼Œç”¨äºåˆ›å»ºåˆç†çš„é»˜è®¤ç»“æ„
                                    const today = new Date();
                                    const formattedDate = formatDate(today);
                                    const currentMonthKey = getCurrentMonthKey();
                                    
                                    // åˆ›å»ºæ›´å®Œæ•´çš„é»˜è®¤æ•°æ®ç»“æ„
                                    const defaultData = {
                                        tasks: {},  // å¯¹è±¡æ ¼å¼ï¼ŒæŒ‰æ—¥æœŸç»„ç»‡
                                        todo: [],   // å¾…åŠç®±é¡¹ç›®
                                        summaries: {}, // æ€»ç»“ï¼ŒæŒ‰æ—¥æœŸç»„ç»‡
                                        monthlyGoals: {}, // æœˆåº¦ç›®æ ‡ï¼ŒæŒ‰æœˆä»½ç»„ç»‡
                                        version: '1.0',
                                        lastUpdated: new Date().toISOString()
                                    };
                                    
                                    // ä¸ºå½“å‰æ—¥æœŸæ·»åŠ ä¸€ä¸ªç¤ºä¾‹ä»»åŠ¡ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£æ•°æ®ç»“æ„
                                    defaultData.tasks[formattedDate] = [
                                        {
                                            id: Date.now().toString(),
                                            content: 'æ¬¢è¿ä½¿ç”¨TODOæ¸…å•ï¼',
                                            completed: false,
                                            date: formattedDate,
                                            description: 'æ‚¨çš„æ•°æ®å·²æ¢å¤ã€‚è¯·å¼€å§‹æ·»åŠ æ–°ä»»åŠ¡ã€‚'
                                        }
                                    ];
                                    
                                    // ä¸ºå½“å‰æœˆä»½æ·»åŠ ä¸€ä¸ªç¤ºä¾‹ç›®æ ‡
                                    defaultData.monthlyGoals[currentMonthKey] = [
                                        'è®¾ç½®æœ¬æœˆçš„é‡è¦ç›®æ ‡',
                                        'å®šæœŸå¤‡ä»½æ‚¨çš„æ•°æ®'
                                    ];
                                    
                                    // ä¿å­˜é»˜è®¤æ•°æ®
                                    localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
                                    console.log('âœ… ä½¿ç”¨å¢å¼ºçš„é»˜è®¤æ•°æ®ç»“æ„åˆå§‹åŒ–æˆåŠŸ');
                                    
                                    // é‡æ–°åŠ è½½
                                    loadTasks();
                                    loadSummary();
                                    loadMonthlyGoals();
                                    
                                    // æ˜¾ç¤ºæ›´å‹å¥½çš„æ¢å¤æˆåŠŸæ¶ˆæ¯
                                    showSyncStatus('æ•°æ®å·²æ¢å¤ï¼åˆ›å»ºäº†æ–°çš„æ•°æ®ç»“æ„ã€‚æ‚¨å¯ä»¥å®‰å…¨åœ°æ·»åŠ æ–°ä»»åŠ¡ã€‚', true);
                                    
                                    // æç¤ºç”¨æˆ·å¯ä»¥å…ˆæŸ¥çœ‹æœ¬åœ°æ•°æ®ï¼Œç„¶åå†³å®šæ˜¯å¦ä¸Šä¼ 
                                    setTimeout(() => {
                                        if (confirm('æ‚¨çš„æ•°æ®å·²æ¢å¤ï¼æ˜¯å¦éœ€è¦ç«‹å³ä¸Šä¼ è¿™ä¸ªæ–°çš„æ•°æ®ç»“æ„åˆ°GitHubï¼Ÿè¿™å°†è¦†ç›–GitHubä¸Šçš„æ— æ•ˆæ•°æ®ã€‚')) {
                                            syncToGithubBtn.click();
                                        }
                                    }, 1500);
                                    
                                } catch (defaultError) {
                                    console.error('åˆ›å»ºé»˜è®¤æ•°æ®ç»“æ„å¤±è´¥:', defaultError);
                                    
                                    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥åœ¨localStorageä¸­åˆ›å»ºç©ºå¯¹è±¡
                                    try {
                                        localStorage.setItem(STORAGE_KEY, JSON.stringify({}));
                                        console.log('âœ… å¤‡ç”¨æ–¹æ¡ˆï¼šå·²åˆ›å»ºç©ºæ•°æ®ç»“æ„');
                                        showSyncStatus('æ•°æ®å·²æ¢å¤ä¸ºç©ºç™½çŠ¶æ€ã€‚è¯·å¼€å§‹æ·»åŠ æ–°ä»»åŠ¡ã€‚', true);
                                        loadTasks();
                                    } catch (finalError) {
                                        console.error('æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥:', finalError);
                                        showSyncStatus('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œä½†å·²å°è¯•æ¢å¤ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚', false);
                                    }
                                }
                            }
                        } else {
                            console.error('âŒ æœªæ‰¾åˆ°ä»»ä½•æœ‰å†…å®¹çš„æ–‡ä»¶');
                            showSyncStatus('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®æ–‡ä»¶ï¼Œè¯·å…ˆä¸Šä¼ æ•°æ®', false);
                        }
                    } catch (parseResponseError) {
                        console.error('âŒ è§£æGistå“åº”å¤±è´¥:', parseResponseError);
                        console.error('åŸå§‹å“åº”:', rawResponse);
                        showSyncStatus('æ— æ³•è§£æGitHubè¿”å›çš„æ•°æ®', false);
                    }
                } else {
                    console.error(`âŒ GitHub API è¿”å›é”™è¯¯: ${response.status} ${response.statusText}`);
                    
                    try {
                        const errorDetails = await response.json();
                        console.error('é”™è¯¯è¯¦æƒ…:', errorDetails);
                        
                        // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºå…·ä½“ä¿¡æ¯
                        let errorMessage;
                        if (errorDetails.message) {
                            errorMessage = errorDetails.message;
                        } else if (errorDetails.documentation_url) {
                            errorMessage = `è¯·æŸ¥çœ‹GitHubæ–‡æ¡£: ${errorDetails.documentation_url}`;
                        } else {
                            errorMessage = `çŠ¶æ€ç : ${response.status}`;
                        }
                        
                        console.error('é”™è¯¯æ¶ˆæ¯:', errorMessage);
                        showSyncStatus(`ä¸‹è½½å¤±è´¥: ${errorMessage}`, false);
                    } catch (jsonError) {
                        console.error('âŒ æ— æ³•è§£æé”™è¯¯å“åº”:', jsonError);
                        console.error('åŸå§‹é”™è¯¯å“åº”:', rawResponse);
                        showSyncStatus(`ä¸‹è½½å¤±è´¥: æœåŠ¡å™¨è¿”å›é”™è¯¯ ${response.status} ${response.statusText}`, false);
                    }
                }
            } catch (error) {
                console.error('âŒ åŒæ­¥è¿‡ç¨‹å‘ç”Ÿé”™è¯¯:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                showSyncStatus(`ä¸‹è½½å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, false);
            } finally {
                console.log('===========================================');
                console.log('åŒæ­¥è¿‡ç¨‹ç»“æŸ');
            }
        }
        
        // åŠ è½½å½“æœˆç›®æ ‡
        function loadMonthlyGoals() {
            try {
                const data = localStorage.getItem(MONTHLY_GOALS_KEY);
                const monthlyGoals = data ? JSON.parse(data) : {};
                const currentMonthKey = getCurrentMonthKey();
                const currentGoals = monthlyGoals[currentMonthKey] || [];
                
                // æ¸…ç©ºåˆ—è¡¨ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ªç©ºè¾“å…¥æ¡†
                goalsList.innerHTML = '';
                
                if (currentGoals.length === 0) {
                    // å¦‚æœæ²¡æœ‰ç›®æ ‡ï¼Œæ·»åŠ ä¸€ä¸ªç©ºè¾“å…¥æ¡†
                    addEmptyGoalInput();
                } else {
                    // æ¸²æŸ“æ‰€æœ‰ç›®æ ‡
                    currentGoals.forEach((goal, index) => {
                        addGoalToUI(goal, index);
                    });
                    // æœ€åæ·»åŠ ä¸€ä¸ªç©ºè¾“å…¥æ¡†
                    addEmptyGoalInput();
                }
                
                return monthlyGoals;
            } catch (error) {
                console.error('åŠ è½½å½“æœˆç›®æ ‡å¤±è´¥:', error);
                return {};
            }
        }
        
        // ä¿å­˜å½“æœˆç›®æ ‡
        function saveMonthlyGoals(monthlyGoals) {
            localStorage.setItem(MONTHLY_GOALS_KEY, JSON.stringify(monthlyGoals));
        }
        
        // æ·»åŠ ç©ºçš„ç›®æ ‡è¾“å…¥æ¡†
        function addEmptyGoalInput() {
            const goalItem = document.createElement('div');
            goalItem.className = 'goal-item flex items-center';
            goalItem.innerHTML = `
                <input type="text" class="goal-input flex-1 px-3 py-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg" placeholder="æ·»åŠ å½“æœˆç›®æ ‡...">
            `;
            
            const input = goalItem.querySelector('.goal-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    handleGoalInputEnter(input);
                }
            });
            
            goalsList.appendChild(goalItem);
            // è‡ªåŠ¨èšç„¦åˆ°æ–°æ·»åŠ çš„è¾“å…¥æ¡†
            input.focus();
        }
        
        // æ·»åŠ ç›®æ ‡åˆ°UI
        function addGoalToUI(goal, index) {
            const goalItem = document.createElement('div');
            goalItem.className = 'goal-item flex items-center';
            goalItem.innerHTML = `
                <input type="text" class="goal-input flex-1 px-3 py-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary rounded-lg" value="${goal}">
                <button class="delete-goal-btn text-gray-400 hover:text-danger ml-2 px-2 py-1 rounded-full">
                    <i class="fa fa-times"></i>
                </button>
            `;
            
            const input = goalItem.querySelector('.goal-input');
            const deleteBtn = goalItem.querySelector('.delete-goal-btn');
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleGoalInputEnter(input, index);
                }
            });
            
            input.addEventListener('blur', () => {
                if (input.value.trim() === '') {
                    deleteGoal(index);
                } else {
                    updateGoal(index, input.value.trim());
                }
            });
            
            deleteBtn.addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ')) {
                    deleteGoal(index);
                }
            });
            
            goalsList.appendChild(goalItem);
        }
        
        // å¤„ç†ç›®æ ‡è¾“å…¥æ¡†çš„å›è½¦äº‹ä»¶
        function handleGoalInputEnter(input, index) {
            const value = input.value.trim();
            if (!value) return;
            
            if (index !== undefined) {
                // æ›´æ–°å·²æœ‰ç›®æ ‡
                updateGoal(index, value);
            } else {
                // æ·»åŠ æ–°ç›®æ ‡
                addNewGoal(value);
            }
            
            // ç¡®ä¿æœ€åæœ‰ä¸€ä¸ªç©ºè¾“å…¥æ¡†
            const lastItem = goalsList.lastElementChild;
            const lastInput = lastItem.querySelector('.goal-input');
            
            if (lastInput && lastInput.value.trim() !== '') {
                addEmptyGoalInput();
            } else if (!lastItem) {
                addEmptyGoalInput();
            }
        }
        
        // æ·»åŠ æ–°ç›®æ ‡
        function addNewGoal(content) {
            const monthlyGoals = loadMonthlyGoals();
            const currentMonthKey = getCurrentMonthKey();
            
            if (!monthlyGoals[currentMonthKey]) {
                monthlyGoals[currentMonthKey] = [];
            }
            
            monthlyGoals[currentMonthKey].push(content);
            saveMonthlyGoals(monthlyGoals);
            
            // é‡æ–°åŠ è½½ç›®æ ‡
            loadMonthlyGoals();
        }
        
        // æ›´æ–°ç›®æ ‡
        function updateGoal(index, content) {
            const monthlyGoals = loadMonthlyGoals();
            const currentMonthKey = getCurrentMonthKey();
            
            if (monthlyGoals[currentMonthKey] && monthlyGoals[currentMonthKey][index] !== undefined) {
                monthlyGoals[currentMonthKey][index] = content;
                saveMonthlyGoals(monthlyGoals);
            }
        }
        
        // åˆ é™¤ç›®æ ‡
        function deleteGoal(index) {
            const monthlyGoals = loadMonthlyGoals();
            const currentMonthKey = getCurrentMonthKey();
            
            if (monthlyGoals[currentMonthKey] && monthlyGoals[currentMonthKey][index] !== undefined) {
                monthlyGoals[currentMonthKey].splice(index, 1);
                
                if (monthlyGoals[currentMonthKey].length === 0) {
                    delete monthlyGoals[currentMonthKey];
                }
                
                saveMonthlyGoals(monthlyGoals);
                loadMonthlyGoals();
            }
        }
        
        // åˆ‡æ¢å½“æœˆç›®æ ‡çš„æ˜¾ç¤º/éšè—
        function toggleMonthlyGoals() {
            monthlyGoalsContainer.classList.toggle('hidden');
            const isHidden = monthlyGoalsContainer.classList.contains('hidden');
            
            if (isHidden) {
                toggleGoalsBtn.innerHTML = '<i class="fa fa-chevron-down mr-1"></i>å±•å¼€';
            } else {
                toggleGoalsBtn.innerHTML = '<i class="fa fa-chevron-down mr-1"></i>å±•å¼€/æ”¶èµ·';
            }
        }
        
            // äº‹ä»¶ç›‘å¬å™¨
            taskTypeSelect.addEventListener('change', loadTasks);
            datePicker.addEventListener('change', () => {
                loadTasks();
                loadSummary();
                loadMonthlyGoals();  // æ·»åŠ è¿™ä¸€è¡Œæ¥æ›´æ–°å½“æœˆç›®æ ‡
            });
        
        // æ—¥æœŸå¯¼èˆªæŒ‰é’®äº‹ä»¶
        document.getElementById('prevDayBtn').addEventListener('click', () => {
            const currentDate = new Date(datePicker.value);
            currentDate.setDate(currentDate.getDate() - 1);
            datePicker.value = formatDate(currentDate);
            loadTasks();
            loadSummary();
            loadMonthlyGoals();  // æ·»åŠ è¿™ä¸€è¡Œæ¥æ›´æ–°å½“æœˆç›®æ ‡
        });
        
        document.getElementById('nextDayBtn').addEventListener('click', () => {
            const currentDate = new Date(datePicker.value);
            currentDate.setDate(currentDate.getDate() + 1);
            datePicker.value = formatDate(currentDate);
            loadTasks();
            loadSummary();
            loadMonthlyGoals();  // æ·»åŠ è¿™ä¸€è¡Œæ¥æ›´æ–°å½“æœˆç›®æ ‡
        });
        
        // æ¸…é™¤æ—¥æœŸæŒ‰é’®äº‹ä»¶
        document.getElementById('removeTaskDateBtn').addEventListener('click', () => {
            const taskId = document.getElementById('editTaskId').value;
            const taskType = document.getElementById('editTaskType').value;
            const currentDate = document.getElementById('editTaskDate').value;
            
            // å¦‚æœä»»åŠ¡å½“å‰æœ‰æ—¥æœŸ
            if (currentDate && taskType === 'dayTodo') {
                const data = loadData();
                const tasks = data.dayTodos[currentDate] || [];
                const task = tasks.find(t => t.id === taskId);
                
                if (task) {
                    // ä»æ—¥æœŸæ—¥ç¨‹ä¸­ç§»é™¤
                    data.dayTodos[currentDate] = tasks.filter(t => t.id !== taskId);
                    
                    // å¦‚æœè¯¥æ—¥æœŸæ²¡æœ‰ä»»åŠ¡äº†ï¼Œåˆ é™¤è¯¥æ—¥æœŸçš„é”®
                    if (data.dayTodos[currentDate].length === 0) {
                        delete data.dayTodos[currentDate];
                    }
                    
                    // æ›´æ–°ä»»åŠ¡ç±»å‹å’Œæ—¥æœŸ
                    task.type = 'todo';
                    task.date = '';
                    
                    // æ·»åŠ åˆ°å¾…åŠäº‹é¡¹
                    data.todos.push(task);
                    
                    saveData(data);
                    
                    // æ¸…ç©ºæ—¥æœŸè¾“å…¥æ¡†
                    document.getElementById('editTaskDate').value = '';
                    
                    // å…³é—­æ¨¡æ€æ¡†å¹¶é‡æ–°åŠ è½½ä»»åŠ¡
                    closeEditModal();
                    loadTasks();
                }
            }
        });
        
        // ç§»åŠ¨åˆ°æ˜å¤©æŒ‰é’®äº‹ä»¶
        document.getElementById('moveToTomorrowBtn').addEventListener('click', () => {
            const taskId = document.getElementById('editTaskId').value;
            const taskType = document.getElementById('editTaskType').value;
            const currentDate = document.getElementById('editTaskDate').value;
            
            // è®¡ç®—æ˜å¤©çš„æ—¥æœŸ
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowFormatted = formatDate(tomorrow);
            
            // è·å–æ•°æ®
            const data = loadData();
            
            if (taskType === 'dayTodo' && currentDate) {
                // ä»å½“å‰æ—¥æœŸç§»é™¤ä»»åŠ¡
                const currentTasks = data.dayTodos[currentDate] || [];
                const task = currentTasks.find(t => t.id === taskId);
                
                if (task) {
                    // ä»å½“å‰æ—¥æœŸç§»é™¤
                    data.dayTodos[currentDate] = currentTasks.filter(t => t.id !== taskId);
                    
                    // å¦‚æœå½“å‰æ—¥æœŸæ²¡æœ‰ä»»åŠ¡äº†ï¼Œåˆ é™¤è¯¥æ—¥æœŸçš„é”®
                    if (data.dayTodos[currentDate] && data.dayTodos[currentDate].length === 0) {
                        delete data.dayTodos[currentDate];
                    }
                    
                    // æ·»åŠ åˆ°æ˜å¤©
                    if (!data.dayTodos[tomorrowFormatted]) {
                        data.dayTodos[tomorrowFormatted] = [];
                    }
                    
                    // æ›´æ–°ä»»åŠ¡æ—¥æœŸ
                    task.date = tomorrowFormatted;
                    
                    // æ·»åŠ åˆ°æ˜å¤©çš„æ—¥ç¨‹
                    data.dayTodos[tomorrowFormatted].push(task);
                    
                    saveData(data);
                    
                    // æ›´æ–°ç¼–è¾‘æ¨¡æ€æ¡†ä¸­çš„æ—¥æœŸæ˜¾ç¤º
                    document.getElementById('editTaskDate').value = tomorrowFormatted;
                    
                    // å…³é—­æ¨¡æ€æ¡†å¹¶é‡æ–°åŠ è½½ä»»åŠ¡ï¼ˆä¸æ”¹å˜å½“å‰æ˜¾ç¤ºçš„æ—¥æœŸï¼‰
                    closeEditModal();
                    loadTasks();
                }
            } else if (taskType === 'todo') {
                // å¦‚æœæ˜¯å¾…åŠäº‹é¡¹ï¼Œè½¬æ¢ä¸ºæ˜å¤©çš„æ—¥ç¨‹
                const task = data.todos.find(t => t.id === taskId);
                
                if (task) {
                    // ä»å¾…åŠäº‹é¡¹ä¸­ç§»é™¤
                    data.todos = data.todos.filter(t => t.id !== taskId);
                    
                    // æ·»åŠ åˆ°æ˜å¤©çš„æ—¥ç¨‹
                    if (!data.dayTodos[tomorrowFormatted]) {
                        data.dayTodos[tomorrowFormatted] = [];
                    }
                    
                    // æ›´æ–°ä»»åŠ¡ç±»å‹å’Œæ—¥æœŸ
                    task.type = 'dayTodo';
                    task.date = tomorrowFormatted;
                    
                    // æ·»åŠ åˆ°æ˜å¤©çš„æ—¥ç¨‹
                    data.dayTodos[tomorrowFormatted].push(task);
                    
                    saveData(data);
                    
                    // æ›´æ–°ç¼–è¾‘æ¨¡æ€æ¡†ä¸­çš„æ—¥æœŸæ˜¾ç¤º
                    document.getElementById('editTaskDate').value = tomorrowFormatted;
                    
                    // å…³é—­æ¨¡æ€æ¡†å¹¶é‡æ–°åŠ è½½ä»»åŠ¡
                    closeEditModal();
                    loadTasks();
                }
            }
        });
        
        githubBtn.addEventListener('click', () => {
            githubSyncModule.classList.toggle('hidden');
        });
        
        closeGithubBtn.addEventListener('click', () => {
            githubSyncModule.classList.add('hidden');
        });
        
        addTaskBtn.addEventListener('click', addTask);
        
        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });
        
        closeEditModalBtn.addEventListener('click', closeEditModal);
        
        cancelEditBtn.addEventListener('click', closeEditModal);
        
        editForm.addEventListener('submit', updateTask);
        
        saveSummaryBtn.addEventListener('click', saveSummary);
        
        syncToGithubBtn.addEventListener('click', syncToGitHub);
        
        syncFromGithubBtn.addEventListener('click', syncFromGitHub);
        
        // è‡ªåŠ¨åŒæ­¥å¼€å…³äº‹ä»¶
        autoSyncToggle.addEventListener('change', () => {
            saveSyncSettings();
            if (autoSyncToggle.checked) {
                startAutoSync();
                showSyncStatus('è‡ªåŠ¨åŒæ­¥å·²å¼€å¯');
            } else {
                stopAutoSync();
                showSyncStatus('è‡ªåŠ¨åŒæ­¥å·²å…³é—­');
            }
        });
        
        // å½“æœˆç›®æ ‡å±•å¼€/æ”¶èµ·äº‹ä»¶
        toggleGoalsBtn.addEventListener('click', toggleMonthlyGoals);
        
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', (e) => {
                if (e.target === editModal) {
                    closeEditModal();
                }
            });
    </script>
</body>
</html>











